name: ğŸš€ Algorythmos Social Publisher

on:
  # Run once daily, ~5 minutes after fetcher (allows time for Notion write)
  schedule:
    - cron: "10 8 * 3-10 *"     # 08:10 UTC â‰ˆ 10:10 Paris during CEST (Marâ€“Oct)
    - cron: "10 9 * 11,12,1,2 *" # 09:10 UTC â‰ˆ 10:10 Paris during CET (Novâ€“Feb)
  workflow_run:
    workflows: ["ğŸ“° Algorythmos Content Aggregator"]  # run right after fetcher
    types: [completed]
  workflow_dispatch:  # Allow manual trigger and API trigger from fetch workflow

concurrency:
  group: algorythmos-social-publisher
  cancel-in-progress: true

jobs:
  post:
    runs-on: ubuntu-latest
    name: Publish to Social Media
    if: >
      github.event_name == 'schedule'
      || github.event_name == 'workflow_dispatch'
      || (github.event_name == 'workflow_run'
          && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: âœ… Repository checked out
        run: echo "âœ… Repository checked out successfully"

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: âœ… Python environment ready
        run: |
          echo "âœ… Python 3.11 environment set up"
          echo "ğŸ“ Python version: $(python --version)"

      - name: ğŸ“š Install dependencies
        run: |
          echo "ğŸ“¥ Installing Python dependencies from requirements.txt..."
          pip install -r requirements.txt
          echo "âœ… Dependencies installed successfully"
          echo "ğŸ“¦ Installed packages:"
          pip list

      - name: ğŸ” Verify content ready for publication
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          LOG_LEVEL: INFO
        run: |
          echo "ğŸ” Checking Notion for scheduled content..."
          echo "ğŸ“Š Notion DB ID: ${{ secrets.NOTION_DB_ID }}"
          echo "ğŸ”‘ Notion Token: ${NOTION_TOKEN:0:20}..."
          python check_ready_to_post.py || { echo "âš ï¸ No Scheduled rows ready. Skipping."; exit 0; }
          echo "âœ… Content verification complete"

      - name: ğŸ¦ Publish to X (Twitter)
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LOG_LEVEL: INFO
        run: |
          echo "ğŸ¦ Starting X (Twitter) publication..."
          echo "ğŸ”‘ X API Key: ${X_API_KEY:0:20}..."
          echo "ğŸ”‘ X Access Token: ${X_ACCESS_TOKEN:0:20}..."
          python main.py --platform x
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully published to X"
          else
            echo "âŒ Failed to publish to X"
            exit 1
          fi

      - name: ğŸ’¼ Publish to LinkedIn
        if: secrets.LINKEDIN_ACCESS_TOKEN != ''
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_ORG_ID: ${{ secrets.LINKEDIN_ORG_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LOG_LEVEL: INFO
        run: |
          echo "ğŸ’¼ Starting LinkedIn publication..."
          echo "ğŸ”‘ LinkedIn Access Token: ${LINKEDIN_ACCESS_TOKEN:0:20}..."
          echo "ğŸ¢ LinkedIn Org ID: ${{ secrets.LINKEDIN_ORG_ID }}"
          python main.py --platform linkedin
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully published to LinkedIn"
          else
            echo "âŒ Failed to publish to LinkedIn"
            exit 1
          fi
